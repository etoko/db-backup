#!/bin/bash
#Version 1.3.4
#db-backup
#
#####################################################################
# Script does four things;
# -Back up a database to path
# -Compress the backup using gzip compression tool
# -Encrypt the backup
# -rsync the backup directory to (a) file server(s).
# 
##################################################################
# Created: Emmanuel Toko 2010-09-21 14:41 0.1
#####################################################################

#Variables
DATE=`date +%F~%T`
ALIAS=openmrs
FILENAME="$HOME" "backups/$ALIAS-$DATE.sql"
LOGFILE="$HOME" "backups/log/backup-log"
BACKUPDIR="$HOME" "/home/user/backups/"
MKDIR=/bin/mkdir
TOUCH=/usr/bin/touch
LOGGER=/usr/bin/logger

#Programs
MYSQLDUMP=/usr/bin/mysqldump
GPG=/usr/bin/gpg
PING=/bin/ping
RSYNC=/usr/bin/rsync
GZIP=/bin/gzip
UNLINK=/usr/bin/unlink

if [ ! -e $BACKUPDIR ]
	$MKDIR -p $BACKUPDIR/log
	$TOUCH $LOGFILE
fi

#Load VERBOSE setting and other rcS variables
. /lib/init/vars.sh

#LSB log-* functions
. /lib/lsb/init-functions

[ -x "$MYSQLDUMP" ] || exit 1

if [ ! -x $GPG ]
then
    log_warning_msg "gpg is not installed backup won't be encrypted"
    echo "Do you want to backup without encrypting y/n "
    
    read CONFIRMATION

    case "$CONFIRMATION"
        y )
         ;;
        n ) exit 0 ;;
        * ) echo "Enter y or n"
        shift
    esac
fi

#Backup   db
log_action_begin_msg "Backing up database"
$MYSQLDUMP -u   -ppasswd   > $FILENAME

if [ "$?" -eq "$SUCCESS_STATUS" ]
then
	log_action_end_msg "$?"
else
	log_failure_msg "Encountered an error during backup"
	exit 1
fi

#Compress file
log_action_begin_msg "Compressing   backup using gzip"
$GZIP $FILENAME
if [ "$?" -eq "$SUCCESS_STATUS" ]
then
	log_action_end_msg "$?"
	echo "...successfully compressed db dump $FILENAME" &>>$LOGFILE	
else
	log_failure_msg "$?"
	echo "...Experienced an error while compressing file $FILENAME" &>>$LOGFILE
	exit 1 #Consider making it possible to send backup files despite the fact that they may not be well compressed
fi

log_action_begin_msg "Encrypting backup"
FILE_EXTENSION=".gz"
COMPRESSED_FILENAME=$FILENAME$FILE_EXTENSION
$GPG --yes --passphrase="your_passphrase" -c $COMPRESSED_FILENAME
 	
if [ "$?" -eq "$SUCCESS_STATUS" ]
then
	log_action_end_msg "$?"
	echo "successfully encrypted backup" &>>$LOGFILE
	$UNLINK $COMPRESSED_FILENAME
else
	log_failure_msg "$?"
	echo "experienced an error during encryption" &>>$LOGFILE
fi

####
#function rsyncs files to host(s)
###########
scopy() {

    HOSTS=("${@}")
     
    SUCCESS_STATUS=0
    PING_COUNT=5 # number of pings

    for RHOST in ${HOSTS[@]}
    do
        HOST=`echo RHOST | cut -d':' -f 1 | cut -d'@' -f 2`
    
        COUNT=$(ping -c $PING_COUNT $HOST | grep 'received' | awk -F',' '{ print $2 }' | awk '{ print $1 }')
        if [ $COUNT -eq $SUCCESS_STATUS ]; then #name of the variable 'SUCCESS_STATUS' is kind of a misnomer here
            # 100% failed
            OFFLINE_HOSTS=$OFFLINE_HOSTS" "$RHOST
            log_failure_msg "$RHOST is probably down/offline"
            #echo "Host : $RHOST is down (ping failed) at $(date)" #| mail -s "$SUBJECT" $EMAILID
            #echo "Host : $RHOST is down (ping failed) at $(date)" &>>$LOGFILE
        else
            log_action_begin_msg "Copying backup(s) to host: $RHOST"
            $RSYNC -ar $BACKUPDIR $RHOST
            if [ "$?" -eq "$SUCCESS_STATUS" ]
            then
                log_action_end_msg "$?"
            else
                log_failure_msg "Experienced error copying backup(s) to $RHOST" 
            fi
            #echo "$RHOST is online"
        fi
        done
}

if [ -n $? ]
then
    scopy $?
    exit 0	
fi

##Space separated list of backup hosts Backup hosts
RHOSTS=(
	"user1@172.16.126.11:backups/ /" 
	"user2@172.16.126.9:home/backup/" 
	"user3@172.16.5.3:backups/" 
	"user4@172.16.5.1:backups"
)

scopy $RHOST
exit 0

#Copy files to file server
echo "Copying backups to file server..."&>>$LOGFILE
#log_action_begin_msg "Copying backups to file server ..."


# email report when
SUBJECT="Ping failed"
EMAILID="admin@localhost"
OFFLINE_HOSTS=""


sleep 120 #wait 2 minute(s) before we attempt to reconnect to the failed/offline hosts to see if they are back online

log_action_begin_msg "Trying to copy (again) to failed hosts"

for RHOST in $OFFLINE_HOSTS
do
    HOST=`echo $RHOST | cut -d':' -f 1 | cut -d'@' -f 2`
    
    COUNT=$(ping -c $PING_COUNT $HOST | grep 'received' | awk -F',' '{ print $2 }' | awk '{ print $1 }')
    if [ $COUNT -eq $SUCCESS_STATUS ]; then
    # 100% failed
        $OFFLINE_HOSTS=$OFFLINE_HOSTS+$RHOST
        log_failure_msg "$RHOST is down ($?)"
        echo "Host : $RHOST is down (ping failed) at $(date)" | tee -a $LOGFILE
    else
        log_action_begin_msg "Copying backups to host: $RHOST"
        $RSYNC -ar $BACKUPDIR $RHOST
        if [ "$?" -eq "$SUCCESS_STATUS" ]
        then
            log_action_end_msg "$?"
            echo "Successfully copied backups to host: $RHOST" | tee -a $LOGFILE
        else
            log_failure_msg "$?"
            echo "Experienced an error when copying the backups to host: $RHOST" | tee -a $LOGFILE
        fi
        #echo "$RHOST is online"
    fi
done

exit 0
